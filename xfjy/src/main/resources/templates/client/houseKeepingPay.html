<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head>
<title>订单确认</title>
<link rel="stylesheet" th:href="@{/app/css/bootstrap.min.css}" />
<link rel="stylesheet" th:href="@{/app/css/bootstrap-theme.min.css}" />
<link rel="stylesheet" th:href="@{/app/css/public.css}" />
<meta content="IE=edge" http-equiv="X-UA-Compatible" />
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0" />
<script th:src="@{/app/js/vendor/jquery-1.11.1.js}"></script>
<script th:src="@{/app/js/vendor/bootstrap.min.js}"></script>
<script th:src="@{/app/js/public.js}"></script>
<script th:src="@{/app/datepicker/js/mobiscroll_002.js}" type="text/javascript"></script>
<script th:src="@{/app/datepicker/js/mobiscroll_004.js}" type="text/javascript"></script>
<link th:href="@{/app/datepicker/css/mobiscroll_002.css}" rel="stylesheet" type="text/css" />
<link th:href="@{/app/datepicker/css/mobiscroll.css}" rel="stylesheet" type="text/css" />
<script th:src="@{/app/datepicker/js/mobiscroll.js}" type="text/javascript"></script>
<script th:src="@{/app/datepicker/js/mobiscroll_003.js}" type="text/javascript"></script>
<script th:src="@{/app/datepicker/js/mobiscroll_005.js}" type="text/javascript"></script>
<link th:href="@{/app/datepicker/css/mobiscroll_003.css}" rel="stylesheet" type="text/css" />
<style type="text/css">
body, html {
	height: 100%;
}

.pto {
	height: 78px;
	background-size: cover;
	-webkit-border-radius: 50%
}
</style>

<script type="text/javascript">
/*<![CDATA[*/
 var prepay_id=''; 
var appId='';
var timeStamp='';
var nonceStr='';
var packages='';
var signType='';
var paySign='';
function createOrder(){
	var couponCheck=$("#payMode4yhq").prop('checked');
	var openId=$("#openId").val();
	if(couponCheck==true){
		if($("#couponId").val()==''){
			$("#spnwarngin").text('请选择优惠券！');
			return;
		}
	}
	var state=$("#state").val();
	if(state=='S'){
		var secondPayAmount=$('#secondPayAmount').val();
		if(secondPayAmount<=0){
			$("#spnwarngin").text('请选择会员费！');
			return;
		}
	}
	
	$("#btnPay").text('支付中...');
	$("#btnPay").attr("disabled",true); 
	 $.ajax({
            type: "POST",
            url: basePath+'/client/createOrder',
            data:$("#aform").serialize(),
            success: function(data) {
            	if(data.resultCode=="S"){
            		if(data.payMode=='OW' || data.payMode=='WY'|| data.payMode=='WC'){//如果支付方式为
            			prepay_id=data.prepay_id;
                		appId=data.parm.appId;
                		timeStamp=data.parm.timeStamp;
                		nonceStr=data.parm.nonceStr;
                		packages=data.parm.package;
                		paySign=data.parm.paySign;
                		pay();
            		}else{
            			 alert('订单已成功处理！');
            			 $("#btnPay").text('支付成功');
            			 window.location.href=basePath+"/client/index.html?openId="+openId;
            		}
            	}else{
            		 alert('订单处理失败！');
            	}
            }
        }); 
}
 

function cbcheck(flag){
	 if(flag=='B'){
		 if($("#payMode4ye").prop("checked")==true){
			 $("#payMode4ye").prop("checked",false);
		 }else{
			 $("#payMode4ye").prop("checked",true);
		 }
		
	 }else{
		 if($("#payMode4yhq").prop("checked")==true){
			 $("#payMode4yhq").prop("checked",false);
		 }else{
			 $("#payMode4yhq").prop("checked",true);
		 }
		 
	 }
	 resetCheckBox(flag);
}

function resetCheckBox(flag){
	if(flag=='B'){
		 if($("#payMode4ye").prop('checked')==true){
			  $("#payMode4yhq").prop('checked',false);
			  $("#couponId").val('');
			  $("input[name='cbcouponId']").prop('checked',false);
			  $("input[name='cbcouponId']").hide();
			  $("span[name='txtrdcoupon']").hide();
			  $("#payMode").val('OY');
		  }else{
			  $("#payMode").val('');
		  }
	 }else{
		 if($("#payMode4yhq").prop('checked')==true){
			 $("#payMode").val('OC');
			  $("#payMode4ye").prop('checked',false);
			  cbcheck4coupon();
		  }else{
			  $("#payMode").val('');
		  }
	 }
}

 
function onBridgeReady(){
	   WeixinJSBridge.invoke(
	       'getBrandWCPayRequest',{
	           "appId" : appId,     //公众号名称，由商户传入     
	           "timeStamp":timeStamp,         //时间戳，自1970年以来的秒数     
	           "nonceStr" : nonceStr, //随机串     
	           "package" : packages,     
	           "signType" : 'MD5',         //微信签名方式：     
	           "paySign" :paySign //微信签名 
	       },
	       function(res){  
	           if(res.err_msg == "get_brand_wcpay_request:ok" ) {
	        	   $("#btnPay").text('已支付');
	        	   alert('支付成功！');
	           }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
	       }
	   ); 
	}



function pay(){
	if (typeof WeixinJSBridge == "undefined"){
	   if( document.addEventListener ){
	       document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
	   }else if (document.attachEvent){
	       document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
	       document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
	   }
	}else{
	   onBridgeReady();
	}
}

function disable(){
	 var balance= $("#spnfee").text();
	 var iba=parseFloat(balance);
	 if(iba<=0){
		 $("#payMode4ye").attr("disabled",true); 
	 }
	 
	 var couponCount=$("#couponCount").val();
	 var icouponCount=parseFloat(couponCount);
	 if(icouponCount<=0){
		 $("#payMode4yhq").hide(); 
		 $("#spancoupon").hide();
	 }
}
 
function cbcheck4coupon(){
	 if($("#payMode4yhq").prop('checked')==true){
		 $("input[name='cbcouponId']").show();
		 $("span[name='txtrdcoupon']").show();
	 }
}

$(function(){
	var state=$("#state").val();
	if(state=='U'){
		$("#btnPay").text('等待确认');
		$("#btnPay").attr('disabled',true);
	}else if(state=='F'){
		$("#btnPay").hide();
		$("#dvcoupon").hide();
	}
	disable();
});


function calfee(target){
	var fee=$(target).attr('fee');
	fee=parseInt(fee);
	$("#spfeeMemebership").text(fee);
	var memerFee=$("#spfeeMemebership").text();
	var feesalary=$("#spfeesalary").text();
	var secondPayAmount=fee+ parseInt(feesalary)
	$("#sptotalFee").text(secondPayAmount);
	$("#totalFee").val(secondPayAmount);
}
/*]]>*/

</script>
</head>
<body>
	<div style="margin-top: 0px;padding:0 10px;"> 
	<form id="aform" name="aform" method="post">
		<input type="hidden" name="workerId" id="workerId" th:value="${worker.id}" />
		<input type="hidden" name="teacherId" id="teacherId" th:value="${worker.teacher.id}" />
		<input type="hidden" name="id" id="id"   th:value="${order.id}"/>
		<input type="hidden" name="state" id="state"   th:value="${order.state}"/>
		<input type="hidden" name="openId" id="openId"   th:value="${order.openId}"/>
		<input type="hidden" name="mobileNo" id="mobileNo"   th:value="${order.mobileNo}"/>
		<input type="hidden" name="userAddressId"  id="userAddressId" th:value="${order.userAddressId}"/>
		<input type="hidden" name="fullAddress" id="fullAddress" th:value="${order.fullAddress}"/>
		<input type="hidden" name="serviceDate" id="serviceDate" th:value="${order.serviceDate}"/>
		<input type="hidden" name="duration"  id="duration"  th:value="${order.duration}"/>
		<input type="hidden" name="startTime"  id="startTime"  th:value="${order.startTime}"/>
		<input type="hidden" name="endTime"  id="endTime"  th:value="${order.endTime}"/>
		<input type="hidden" name="serviceType" id="serviceType" value="JZ"/>
		<input type="hidden" name="cycleType" id="cycleType" th:value="${order.cycleType}"/>
		<input type="hidden" name="durationMonth" id="durationMonth"   th:value="${order.durationMonth}"/>
  		<input type="hidden" name="repeatInWeek" id="repeatInWeek" th:value="${order.repeatInWeek}"/>
		<input type="hidden" name="repeatInWeekText" id="repeatInWeekText" th:value="${order.repeatInWeekText}" />
  		<input type="hidden" name="durationMonthText" id="durationMonthText" th:value="${order.durationMonthText}" />
  		<input type="hidden" name="durationText" id="durationText" th:value="${order.durationText}" />
  		<input type="hidden" name="isProviceCleanTools" id="isProviceCleanTools" th:value="${order.isProviceCleanTools}" />
  		<input type="hidden" name="area" id="area" th:value="${order.area}" />
  		<input type="hidden" name="windowCount" id="windowCount" th:value="${order.windowCount}" />
  		<input type="hidden" name="balconyCount" id="balconyCount" th:value="${order.balconyCount}" />
  		<input type="hidden" name="name" id="name" th:value="${order.name}" />
  			
  		<input type="hidden" id="couponCount"  name="couponCount" th:value="${couponCount}" />
  		<input type="hidden" id="couponId"  name="couponId"   />
  		<input type="hidden" id="payMode"  name="payMode"   />
  		<input type="hidden" id="totalFee"  name="totalFee" th:value="${order.totalFee}"  />
  		<ul class="list-group" style="margin-top:15px;" th:if="${order.state=='C'}">
			<li class="list-group-item" >
				<label>试用3天金额：</label><span style="color:red" th:text="${order.totalFee}"></span><span style="color:red">元</span>
			</li> 
		</ul> 
		<ul class="list-group" style="margin-top:15px;" th:if="${order.state=='F'}">
			<li class="list-group-item" >
				<label>金额：</label><span style="color:red" th:text="${order.totalFee}"></span><span style="color:red">元</span>
			</li> 
		</ul> 
		<ul class="list-group" style="margin-top:15px;" th:if="${order.state=='S'}">
			<li class="list-group-item" >
				<label>会员费：</label><br/>
				<div class="btn-group btn-group-justified" role="group" aria-label="...">
					  <div class="btn-group" role="group">
					    <button type="button" class="btn btn-default"    fee="680" onclick="calfee(this)" >
					    	680元
					    </button>
					  </div>
					  <div class="btn-group" role="group">
					    <button type="button" class="btn btn-default"  fee="980" onclick="calfee(this)">
					    	980元
					    </button>
					  </div>
					  <div class="btn-group" role="group">
					    <button type="button" class="btn btn-default"  fee="1280" onclick="calfee(this)" >
					    	1280元
					    </button>
					  </div>
					  <div class="btn-group" role="group">
					    <button type="button" class="btn btn-default" fee="1580" onclick="calfee(this)">
					    	1580元
					    </button>
					  </div>
				</div>
			</li>
			<li class="list-group-item" style="color:red">
				<label>总金额：</label>
				<span th:text="${worker.salary}" id="sptotalFee"></span><span style="color:red">元</span>
				<span>(会员费</span><span id="spfeeMemebership"></span>
				<span>元+月工资</span><span id="spfeesalary" th:text="${worker.salary}"></span><span>元)</span>
			</li> 
		</ul>
		<div style="margin-top:10px;height:120px;height:120px;">
			<div id="dvtitle" style="height:32px;" >
				<div style="height:20px;border-bottom:1px solid orange; "></div>
				<h5 style="width:90px;padding:0px 10px;padding-left:15px;margin-left:40px;margin-top:-10px;background-color: white">阿姨信息</h5>
			</div>
			<div style="float:left;height:70px;width:70px;display:block;margin-left:15px;margin-top:5px;">
				<img th:src="@{'http://weixin.tjxfjz.com/xfjy/app/uploadfiles/workerphoto/'+${worker.photo}}" style="height:80px;width:auto"/>
			</div>
			<div style="float:left;width:200px;height:90px;margin-left:20px">
				<span style="font-weight:bold" th:text="${worker.name}"></span><br/>
				<span>参考工资：</span><span th:text="${worker.salary}"></span><span>元/月</span><br/>
				<span th:text="${worker.yearsOld}"></span><span>岁&nbsp;|&nbsp;</span><span th:text="${worker.nativePlace}"></span><span>人</span><br/>
				<span th:text="${worker.serviceTypeTwoName}"></span>
			</div> 
		</div>
		<div id="dvteacher" style="height:100px;">
			<div id="dvtitle" style="height:32px;" >
				<div style="height:20px;border-bottom:1px solid orange; "></div>
				<h5 style="width:90px;padding:0px 10px;padding-left:15px;margin-left:40px;margin-top:-10px;background-color: white">所属老师</h5>
			</div>
			<div style="height:70px;">
				<div style="float:left;height:70px;width:70px;display:block;margin-left:15px;">
					<img th:src="@{/app/img/ayi.jpg}" style="width:48px;height:auto"/>
					<!-- <img th:src="@{'/app/uploadfiles/workerphoto/'+${worker.teacher.photo}}" style="width:48px;height:auto"/> -->
				</div>
				<div style="float:left;width:200px;height:70px;">
					<span style="font-weight:bold" th:text="${worker.teacher.name}"></span><br/>
					<div style="margin-top:5px"></div>
					<span th:text="${worker.teacher.nativePlace}"></span><span>人</span><br/>
					<a th:href="'tel:'+${worker.teacher.phone}" style="color:black" th:text="${worker.teacher.phone}"></a>
				</div> 
			</div>
			<div style="height:1px;background-color:orange"></div>
			<div style="margin-top:15px">
				<ul class="list-group">
	  				<li class="list-group-item" >
	  					<label>地址：</label><span th:text="${order.fullAddress}"></span>
	  				</li>
					<li class="list-group-item">
						<label>服务日期：</label>
						<span th:text="${order.serviceDate}"> </span>
					</li>
				</ul>
				<ul class="list-group">
					<li class="list-group-item">
						<label>姓名：</label>
						<span th:text="${order.name}"></span>
					</li>
					<li class="list-group-item">
						<label>联系方式：</label>
						<span th:text="${order.mobileNo}"></span>
					</li>
				</ul>
			</div>
			<div style="mragin-top:15px;height:40px;font-size:16px" id="dvcoupon">
				<input type="checkbox" style="float:left" id="payMode4ye" name="payMode4ye" onchange="resetCheckBox('B')" value="OY"/>
				<span onclick="cbcheck('B')">使用余额(</span><span th:text="${ds.fee}" id="spnfee" onclick="cbcheck('B')"></span><span  onclick="cbcheck('B')">)元&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
				
				<input type="checkbox"   id="payMode4yhq" name="payMode4yhq" onchange="resetCheckBox('C')" value="OC"/>
				<span onclick="cbcheck('C')" id="spancoupon">使用优惠券</span>
			</div>
			<div>	
				<span th:each="item:${couponList}">
					<input type="radio" name="cbcouponId"  style="display:none"  th:value="${item.id}" onclick="javascript:$('#couponId').val($(this).val())"  />
					<span style="display:none" name="txtrdcoupon" th:text="${item.cash}+'元&nbsp;&nbsp;&nbsp;&nbsp;'"/>
				</span>
			</div>
			<div class="row" id="warnginInfo">
				<div class="col-xs-1"/>
				<div>
					 <span id="spnwarngin" style="font-weight:bold;color:red"></span>
				</div>
				<div class="col-xs-1"/>
			</div>
			<div style="height:70px;margin-top:15px" class="row">
				<div style="margin-top:10px"></div>
				<div class="col-xs-2"></div>
				<div>
					<button type="button" id="btnPay" onclick="createOrder()" class="btn col-xs-8 btn-default btn-lg">支 付</button>
				</div>
				<div class="col-xs-2"></div>
			</div>
			<div style="height:100px;">
			</div>
		</div>
		</form>
	</div>


</body>
</html>
